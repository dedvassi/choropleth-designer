# Choropleth Designer (PyQt6)

Это десктопное приложение на Python с графическим интерфейсом (GUI) на PyQt6, предназначенное для создания хороплетических карт. Оно позволяет пользователям визуализировать географические данные, настраивая интервалы значений и цветовые схемы для различных регионов. Проект был рефакторингован из монолитного скрипта в модульную структуру для улучшения читаемости, поддерживаемости и расширяемости.




## Обзор проекта

Приложение позволяет:

*   Загружать географические данные в форматах GeoJSON или Shapefile.
*   Выбирать поле-идентификатор региона из загруженных геоданных.
*   Загружать данные с показателями из CSV-файлов, указывая столбцы для ключа региона и значения показателя.
*   Объединять загруженные CSV-данные с географическими данными.
*   Редактировать значения показателей для каждого региона непосредственно в таблице приложения.
*   Настраивать интервалы значений (бины) и присваивать им определенные цвета.
*   Настраивать цвета для отсутствующих данных и границы регионов.
*   Строить и отображать хороплетическую карту на основе заданных параметров.
*   Сохранять построенные карты в форматах PNG и SVG.
*   Сохранять и загружать настроенные цветовые схемы в формате JSON для повторного использования.




## Структура проекта

Проект был реорганизован в модульную структуру для повышения удобства разработки и поддержки. Ниже представлена иерархия файлов и краткое описание каждого модуля:

```
choropleth_project/
├── main.py              # Точка входа в приложение. Инициализирует QApplication и запускает главное окно.
├── app.py               # Основная логика приложения. Содержит класс ChoroplethApp, который управляет UI, данными и взаимодействием.
├── ui/
│   ├── __init__.py
│   ├── main_window.py   # Модуль пользовательского интерфейса. Определяет класс UIMainWindow, который строит все виджеты и элементы GUI.
│   └── widgets.py       # (Опционально) Зарезервировано для будущих сложных или кастомных виджетов.
├── core/
│   ├── __init__.py
│   ├── models.py        # Модели данных. Содержит определение класса Bin для интервалов значений.
│   └── data_handler.py  # Обработчик данных. Отвечает за загрузку, объединение и управление географическими и числовыми данными.
├── utils/
│    ├── __init__.py
│    └── file_operations.py # Утилиты для работы с файлами. Содержит функции для сохранения карт и схем.
├── data/
    └── russia.geojson      # Дефолтные геоданные регионов России 
```

### Описание модулей:

*   **`main.py`**: Это стартовый скрипт. Он создает экземпляр `QApplication` и `ChoroplethApp`, а затем запускает цикл событий приложения. Его единственная задача — запустить приложение.

*   **`app.py`**: Сердце приложения. Класс `ChoroplethApp` наследуется от `QMainWindow` и координирует работу всех остальных компонентов. Он содержит бизнес-логику, такую как обработка событий (открытие файлов, объединение данных, построение карты), управление состоянием приложения (текущие данные, интервалы, стили) и взаимодействие с модулями `ui` и `core`.

*   **`ui/main_window.py`**: Этот модуль полностью посвящен построению графического интерфейса. Класс `UIMainWindow` инкапсулирует создание всех кнопок, полей ввода, таблиц, вкладок и других элементов UI. Он не содержит бизнес-логики, а лишь предоставляет методы для доступа к элементам UI и подключения сигналов к слотам в `ChoroplethApp`. Это разделение позволяет легко изменять внешний вид приложения, не затрагивая его основную функциональность.

*   **`core/models.py`**: Содержит простые классы данных, которые используются в приложении. В данный момент это класс `Bin`, представляющий собой один интервал значений с нижней и верхней границами, а также ассоциированным цветом. Это позволяет четко определить структуру данных, используемых для настройки хороплета.

*   **`core/data_handler.py`**: Отвечает за все операции, связанные с данными. Он загружает GeoJSON/Shapefile и CSV, выполняет объединение данных (merge) на основе выбранных пользователем ключей, а также предоставляет методы для доступа к обработанным данным. Этот модуль абстрагирует логику работы с `geopandas` и `pandas` от остальной части приложения, делая код более чистым и тестируемым.

*   **`utils/file_operations.py`**: Содержит вспомогательные функции для сохранения и загрузки файлов, таких как PNG/SVG изображений карты и JSON-файлов со схемами интервалов. Эти функции являются общими утилитами, которые могут быть использованы в разных частях приложения.

Такая структура делает проект более организованным, облегчает отладку и позволяет нескольким разработчикам работать над разными частями приложения одновременно, минимизируя конфликты.




## Установка

Для запуска приложения вам потребуется Python 3.x и несколько библиотек. Рекомендуется использовать виртуальное окружение для управления зависимостями.

1.  **Клонируйте репозиторий (или распакуйте архив):**

    Если вы получили проект в виде архива, распакуйте его в удобное для вас место. Если это репозиторий Git:

    ```bash
    git clone https://github.com/dedvassi/choropleth-designer.git
    cd choropleth-designer
    ```

2.  **Создайте и активируйте виртуальное окружение:**

    ```bash
    python3 -m venv venv
    # Для Windows:
    # .\venv\Scripts\activate
    # Для macOS/Linux:
    source venv/bin/activate
    ```

3.  **Установите зависимости:**

    ```bash
    pip install PyQt6 geopandas pandas matplotlib shapely fiona pyproj
    ```

    *   **`PyQt6`**: Для создания графического интерфейса.
    *   **`geopandas`**: Для работы с геопространственными данными (GeoJSON, Shapefile).
    *   **`pandas`**: Для работы с табличными данными (CSV).
    *   **`matplotlib`**: Для построения и отображения карт.
    *   **`shapely`**: Для геометрических операций (зависимость `geopandas`).
    *   **`fiona`**: Для чтения и записи геопространственных данных (зависимость `geopandas`).
    *   **`pyproj`**: Для преобразования координатных систем (зависимость `geopandas`).




## Использование

После установки зависимостей вы можете запустить приложение:

```bash
python main.py
```

Откроется главное окно приложения с тремя вкладками: "Данные", "Интервалы и цвета" и "Стиль".

### 1. Вкладка "Данные"

Эта вкладка предназначена для загрузки и объединения географических и числовых данных.

*   **Геоданные (GeoJSON/Shapefile):**
    *   Нажмите кнопку "Загрузить…" в секции "Геоданные".
    *   Выберите файл GeoJSON, JSON или Shapefile, содержащий границы регионов.
    *   После загрузки в выпадающем списке "Поле региона" выберите столбец, который содержит уникальные идентификаторы регионов (например, коды ОКАТО, названия регионов).

*   **Показатели (CSV):**
    *   Нажмите кнопку "Загрузить…" в секции "Показатели (CSV)".
    *   Выберите CSV-файл, содержащий данные, которые вы хотите отобразить на карте.
    *   В выпадающем списке "Столбец региона" выберите столбец, который соответствует полю-идентификатору региона из ваших геоданных.
    *   В выпадающем списке "Столбец значения" выберите столбец, содержащий числовые значения, по которым будет строиться хороплет.

*   **Объединение данных:**
    *   После загрузки обоих файлов и выбора соответствующих столбцов нажмите кнопку "Объединить с геоданными".
    *   Приложение объединит географические данные с вашими показателями. В нижней части вкладки появится таблица "Значения по регионам", где вы сможете увидеть и при необходимости вручную отредактировать значения для каждого региона. Двойной клик по ячейке "Значение" позволяет изменить его.

### 2. Вкладка "Интервалы и цвета"

Здесь вы настраиваете, как числовые значения будут группироваться в интервалы и какими цветами они будут отображаться на карте.

*   **Добавление интервалов:**
    *   Нажмите кнопку "Добавить интервал". В таблице появится новая строка.
    *   В столбце "От (вкл)" введите нижнюю границу интервала (включительно).
    *   В столбце "До" введите верхнюю границу интервала (исключительно для всех интервалов, кроме последнего, который является включительным).
    *   В столбце "Цвет" нажмите на ячейку, чтобы открыть палитру цветов, и выберите желаемый цвет для этого интервала.
*   **Удаление интервалов:**
    *   Выберите строку в таблице и нажмите "Удалить выбранный".
*   **Выбор цвета:**
    *   Выберите строку в таблице и нажмите "Выбрать цвет…", чтобы изменить цвет для выбранного интервала.

### 3. Вкладка "Стиль"

Эта вкладка позволяет настроить визуальные параметры карты.

*   **Цвет для отсутствующих значений:**
    *   Нажмите на кнопку рядом с этим полем, чтобы выбрать цвет, который будет использоваться для регионов, по которым нет данных.
*   **Цвет границ регионов:**
    *   Выберите цвет для линий, обозначающих границы регионов.
*   **Толщина границ:**
    *   Используйте спин-бокс для настройки толщины линий границ регионов.

### Построение и сохранение карты

*   **Построить карту:**
    *   После настройки данных, интервалов и стиля нажмите кнопку "Построить карту" в нижней части левой панели.
    *   Карта отобразится в правой части окна.
*   **Сохранение карты:**
    *   Используйте кнопки "Сохранить PNG…" или "Сохранить SVG…" на панели инструментов для сохранения карты в соответствующем формате.

### Сохранение и загрузка схемы

*   **Сохранить схему:**
    *   Нажмите кнопку "Сохранить схему…" на панели инструментов, чтобы сохранить текущие настройки интервалов, цветов и стилей в JSON-файл. Это удобно для повторного использования настроек.
*   **Загрузить схему:**
    *   Нажмите кнопку "Загрузить схему…" на панели инструментов, чтобы загрузить ранее сохраненную схему из JSON-файла.




## Возможные проблемы и их решение

*   **Проблемы с запуском GUI (Qt/XCB):**
    *   Если при запуске приложения вы видите ошибки, связанные с `qt.qpa.plugin` или `xcb`, это означает, что вашей системе не хватает необходимых библиотек для отображения графического интерфейса Qt. На Linux-системах это часто решается установкой пакетов, таких как `libxcb-xinerama0`, `libxcb-xinput0`, `libxcb-xkb1`, `libxcb-cursor0`. Пример команды для Debian/Ubuntu:
        ```bash
        sudo apt-get update
        sudo apt-get install -y libxcb-cursor0 libxcb-xinerama0 libxcb-xinput0 libxcb-xkb1
        ```
    *   Если вы запускаете приложение на сервере без графического окружения (как это было в моей изолированной среде), вам может потребоваться `xvfb` (X Virtual Framebuffer) для создания виртуального дисплея:
        ```bash
        sudo apt-get install -y xvfb
        xvfb-run python main.py
        ```

*   **Ошибки чтения файлов:**
    *   Убедитесь, что выбранные файлы (GeoJSON, Shapefile, CSV) не повреждены и соответствуют ожидаемым форматам.
    *   Проверьте права доступа к файлам и папкам.

*   **Проблемы с объединением данных:**
    *   Убедитесь, что столбцы-ключи в GeoJSON/Shapefile и CSV-файле содержат одинаковые значения для сопоставления регионов. Регистры символов и лишние пробелы могут быть причиной несовпадений. Приложение пытается привести типы к строке и удалить пробелы, но идеальное совпадение данных — залог успеха.
    *   Убедитесь, что столбец значений в CSV содержит числовые данные. Нечисловые значения будут преобразованы в `NaN` (отсутствующие данные).

## Вклад в разработку

Приветствуются любые предложения и улучшения! Если вы хотите внести свой вклад:

1.  Сделайте форк репозитория.
2.  Создайте новую ветку для вашей функции (`git checkout -b feature/AmazingFeature`).
3.  Внесите изменения и закоммитьте их (`git commit -m 'Add some AmazingFeature'`).
4.  Отправьте изменения в удаленный репозиторий (`git push origin feature/AmazingFeature`).
5.  Откройте Pull Request.

## Лицензия

Этот проект распространяется под лицензией MIT.

## Автор

dedvassi


